<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visu Map</title>    
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
     integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
     crossorigin=""/>

     <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
    crossorigin=""></script>

    <style>
        * {
            margin: 0; padding: 0; 
        }

        .map-container {
            height: 100vh; 
        }
    </style>

    <style id="miniature-only">
        .leaflet-tile-pane {
            filter:grayscale(1); 
        }

        .leaflet-control-container {
            display: none; 
        }
    </style>
</head>

<body>
    <div class="map-container" id="the-map"></div>

    <script src="app.js"></script>
    <script>
        handleRequest(); 

        async function handleRequest() {
            let param_from_url = new URLSearchParams(location.search); 

            let required_track = param_from_url.get('track'); 

            if (!required_track) {
                throw new Error('undefined gpx track'); 
            } 

            let array_of_path = []; 
            if (required_track === "all") {
                let res = await fetch('../controllers/list-of-tracks.php'); 
                let array = await res.json(); 
                array.forEach(item => {
                    array_of_path.push(`../tracks/${item}`); 
                })
            } else {
                array_of_path.push(`../tracks/${required_track}.gpx`); 
            }


            let size = param_from_url.get('size') ?  param_from_url.get('size') : 'miniature'; 

            if (size === 'fullscreen') {
                document.querySelector('#miniature-only').remove(); 
            }

            let readyMap = await initMap(array_of_path); 

            // Initialiser un tableau vide pour stocker les limites
            let allPolylinesBounds = [];
            // Boucler à travers les polylines pour obtenir leurs limites individuelles
            document.polylines.forEach(function(polyline) {
                let bounds = polyline.getBounds();
                allPolylinesBounds.push(bounds);
            });
            // Fusionner les limites de toutes les polylines
            let combinedBounds = allPolylinesBounds.reduce(function(bounds1, bounds2) {
                return bounds1.extend(bounds2);
            });
            // Centrer la vue sur les limites combinées de toutes les polylines
            map.fitBounds(combinedBounds);


            /// bricolage d'interactivité au clic sur un tracé :
            let paths = document.querySelectorAll('path.leaflet-interactive');  

            // document.querySelector('svg.leaflet-zoom-animated').style.position = 'relative'; 
            // paths.forEach(path => {
            //     path.onclick = (event) => {
            //         paths.forEach(path => path.style.stroke = "#ed143db5"); // reset other paths
            //         // document.querySelector('svg.leaflet-zoom-animated').insertAdjacentElement('beforeend', path);  
            //         path.style.stroke = 'black'; 
            //         path.style.zIndex = '2'; 
            //     }
            // })

            // document.polylines.forEach(poly => {
            //     poly.addEventLister('click', event => {
            //         console.log(poly); 
            //         poly.setStyle({color: "teal", weight: 3}).bringToFront(); 
            //     })
            // })

        }
        
        
    </script>
    
</body>

</html>
